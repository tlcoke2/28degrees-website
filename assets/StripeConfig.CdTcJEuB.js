import{l as de,j as e,k as N,r as p,B as I,b as L,C as G,A as K,T,X as ue,I as q,P as H,G as a,g as R,v as O,e as x,M as $,Y,Z as me,h as he,a as M,$ as J,q as F,D as xe,c as pe,d as ye,i as fe}from"./index.BZ6bSIPx.js";import{A as ge}from"./Add.DBOCiMT4.js";import{E as je,D as be}from"./Edit.B9_Pk3f1.js";import{S as V}from"./Snackbar.DN_5azCV.js";const Se=de(e.jsx("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh"),Q="/admin/stripe/config",Ce="/admin/stripe/test-connection";function U(){if(typeof window>"u")return{};const u=localStorage.getItem("adminToken");return u?{Authorization:`Bearer ${u}`}:{}}const X=async()=>{var y;const u=U();if(!("Authorization"in u))throw new Error("Admin authentication required. Please log in to the admin panel.");const i=await N.get(Q,{headers:u}),c=((y=i==null?void 0:i.data)==null?void 0:y.data)??(i==null?void 0:i.data);if(!c)throw new Error("No Stripe config returned from server");return c},ve=async u=>{var g;const i=U();if(!("Authorization"in i))throw new Error("Admin authentication required. Please log in to the admin panel.");const c=await N.put(Q,u,{headers:i}),y=((g=c==null?void 0:c.data)==null?void 0:g.data)??(c==null?void 0:c.data);if(!y)throw new Error("Failed to update Stripe config");return y},Te=async()=>{var u,i,c,y,g,m,k,P;try{const h=U();if(!("Authorization"in h))throw new Error("Admin authentication required. Please log in to the admin panel.");const o=await N.post(Ce,void 0,{headers:h}),l=!!(((u=o==null?void 0:o.data)==null?void 0:u.success)??((c=(i=o==null?void 0:o.data)==null?void 0:i.data)==null?void 0:c.success)),D=((y=o==null?void 0:o.data)==null?void 0:y.message)??((m=(g=o==null?void 0:o.data)==null?void 0:g.data)==null?void 0:m.message);return{success:l,message:D}}catch(h){return{success:!1,message:((P=(k=h==null?void 0:h.response)==null?void 0:k.data)==null?void 0:P.message)||(h==null?void 0:h.message)||"Failed to connect to Stripe"}}},ke=["card","link","us_bank_account","cashapp","klarna","afterpay_clearpay","affirm"],Z={key:"",name:"",description:"",priceCents:0,appliesTo:["tour","event","product"],active:!0},We=()=>{const u=typeof window<"u"&&!!localStorage.getItem("adminToken"),[i,c]=p.useState({isActive:!1,publishableKey:"",secretKey:"",webhookSecret:"",commissionRate:0,currency:"USD",allowedPaymentMethods:["card"],pricingTiers:[],confirmSecretKey:"",confirmWebhookSecret:""}),[y,g]=p.useState(!0),[m,k]=p.useState(!1),[P,h]=p.useState(!1),[o,l]=p.useState(""),[D,W]=p.useState(""),[ee,w]=p.useState(!1),[A,_]=p.useState(null),[d,j]=p.useState(Z);p.useEffect(()=>{u?(async()=>{var n,s;try{g(!0);const r=await X(),f=((n=r==null?void 0:r.metadata)==null?void 0:n.allowedPaymentMethods)||["card"],v=((s=r==null?void 0:r.metadata)==null?void 0:s.pricingTiers)||[];c(E=>({...E,...r,isActive:(r==null?void 0:r.isActive)??!1,publishableKey:(r==null?void 0:r.publishableKey)??"",secretKey:(r==null?void 0:r.secretKey)??"",webhookSecret:(r==null?void 0:r.webhookSecret)??"",commissionRate:(r==null?void 0:r.commissionRate)??0,currency:(r==null?void 0:r.currency)??"USD",allowedPaymentMethods:f,pricingTiers:v,confirmSecretKey:"",confirmWebhookSecret:""}))}catch{l("Failed to load configuration")}finally{g(!1)}})():g(!1)},[u]);const b=t=>{const{name:n,value:s,type:r,checked:f}=t.target;c(v=>({...v,[n]:n==="commissionRate"?Number(s):r==="checkbox"?f:s}))},te=t=>(n,s)=>{c(r=>({...r,[t]:s}))},re=t=>{c(n=>{const s=new Set(n.allowedPaymentMethods);s.has(t)?s.delete(t):s.add(t);const r=Array.from(s);return r.length===0&&r.push("card"),{...n,allowedPaymentMethods:r}})},ne=()=>{j({...Z,currency:i.currency}),_(null),w(!0)},ie=t=>{const n=i.pricingTiers[t];j({...n,currency:n.currency||i.currency}),_(t),w(!0)},se=t=>{c(n=>({...n,pricingTiers:n.pricingTiers.filter((s,r)=>r!==t)}))},ae=()=>{if(!d.key.trim())return l("Tier key is required");if(!d.name.trim())return l("Tier name is required");if(!Number.isFinite(d.priceCents)||d.priceCents<0)return l("Tier price must be a non-negative integer (in cents)");c(t=>{if((A===null?t.pricingTiers.findIndex(r=>r.key===d.key):t.pricingTiers.findIndex((r,f)=>r.key===d.key&&f!==A))>=0)return l("Tier key must be unique"),t;const s=[...t.pricingTiers];return A===null?s.push(d):s[A]=d,{...t,pricingTiers:s}}),w(!1)},ce=async t=>{if(t.preventDefault(),l(""),W(""),!i.publishableKey.trim())return l("Publishable key is required");if(!i.secretKey.trim())return l("Secret key is required");if(i.secretKey!==i.confirmSecretKey)return l("Secret keys do not match");if(i.webhookSecret&&i.confirmWebhookSecret&&i.webhookSecret!==i.confirmWebhookSecret)return l("Webhook secrets do not match");k(!0);try{const{confirmSecretKey:n,confirmWebhookSecret:s,allowedPaymentMethods:r,pricingTiers:f,...v}=i,E={...v,metadata:{...v.metadata,allowedPaymentMethods:r,pricingTiers:(f||[]).map(C=>({...C,priceCents:Math.round(Number(C.priceCents)||0),currency:C.currency||i.currency}))}};await ve(E),W("Configuration saved successfully");const S=await X();c(C=>{var z,B;return{...C,...S,allowedPaymentMethods:((z=S==null?void 0:S.metadata)==null?void 0:z.allowedPaymentMethods)||C.allowedPaymentMethods,pricingTiers:((B=S==null?void 0:S.metadata)==null?void 0:B.pricingTiers)||C.pricingTiers,confirmSecretKey:"",confirmWebhookSecret:""}})}catch(n){l((n==null?void 0:n.message)||"Failed to save configuration")}finally{k(!1)}},oe=async()=>{try{h(!0);const t=await Te();W((t==null?void 0:t.message)||"Stripe connection check succeeded (see server logs for details).")}catch(t){l((t==null?void 0:t.message)||"Stripe connection test failed")}finally{h(!1)}},le=p.useMemo(()=>{var t;try{return(t=new Intl.NumberFormat(void 0,{style:"currency",currency:i.currency||"USD"}).formatToParts(1).find(n=>n.type==="currency"))==null?void 0:t.value}catch{return"$"}},[i.currency]);return y?e.jsx(I,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(L,{})}):u?e.jsxs(G,{maxWidth:"lg",sx:{mt:4,mb:6},children:[e.jsxs(I,{display:"flex",alignItems:"center",gap:2,mb:1,children:[e.jsx(T,{variant:"h4",children:"Stripe Configuration"}),e.jsx(ue,{title:"Test connection",children:e.jsx("span",{children:e.jsx(q,{onClick:oe,disabled:P,children:e.jsx(Se,{})})})})]}),!!o&&e.jsx(K,{severity:"error",sx:{mb:2},children:o}),e.jsx(H,{sx:{p:3},children:e.jsx("form",{onSubmit:ce,children:e.jsxs(a,{container:!0,spacing:3,children:[e.jsx(a,{item:!0,xs:12,children:e.jsx(R,{control:e.jsx(O,{checked:!!i.isActive,onChange:te("isActive"),name:"isActive",disabled:m}),label:"Enable Stripe Payments"})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,label:"Publishable Key",name:"publishableKey",value:i.publishableKey,onChange:b,required:!0,disabled:m})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{select:!0,fullWidth:!0,label:"Currency",name:"currency",value:i.currency,onChange:b,disabled:m,children:["USD","EUR","GBP","CAD","AUD","JMD"].map(t=>e.jsx($,{value:t,children:t},t))})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,label:"Secret Key",name:"secretKey",type:"password",value:i.secretKey,onChange:b,required:!0,disabled:m})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,label:"Confirm Secret Key",name:"confirmSecretKey",type:"password",value:i.confirmSecretKey,onChange:b,required:!0,disabled:m})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,label:"Webhook Secret",name:"webhookSecret",type:"password",value:i.webhookSecret,onChange:b,disabled:m})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,label:"Confirm Webhook Secret",name:"confirmWebhookSecret",type:"password",value:i.confirmWebhookSecret,onChange:b,disabled:m})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,type:"number",inputProps:{step:"0.1",min:0,max:100},label:"Commission Rate (%)",name:"commissionRate",value:i.commissionRate,onChange:b,disabled:m})}),e.jsxs(a,{item:!0,xs:12,children:[e.jsx(Y,{component:"legend",sx:{mb:1},children:"Allowed Payment Methods"}),e.jsx(me,{row:!0,children:ke.map(t=>e.jsx(R,{control:e.jsx(he,{checked:i.allowedPaymentMethods.includes(t),onChange:()=>re(t)}),label:t},t))})]}),e.jsxs(a,{item:!0,xs:12,mt:2,children:[e.jsxs(I,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,children:[e.jsx(T,{variant:"h6",children:"Pricing Tiers"}),e.jsx(M,{startIcon:e.jsx(ge,{}),variant:"outlined",onClick:ne,children:"Add Tier"})]}),i.pricingTiers.length===0?e.jsx(K,{severity:"info",children:"No tiers yet. Add at least one (e.g., Standard, VIP)."}):e.jsx(I,{children:i.pricingTiers.map((t,n)=>e.jsx(H,{variant:"outlined",sx:{p:2,mb:1},children:e.jsxs(a,{container:!0,spacing:1,alignItems:"center",children:[e.jsxs(a,{item:!0,xs:12,md:3,children:[e.jsxs(T,{fontWeight:600,children:[t.name," ",e.jsxs(T,{component:"span",color:"text.secondary",children:["(",t.key,")"]})]}),t.description&&e.jsx(T,{variant:"body2",color:"text.secondary",children:t.description})]}),e.jsx(a,{item:!0,xs:12,md:2,children:e.jsxs(T,{children:[le,(t.priceCents/100).toFixed(2)]})}),e.jsx(a,{item:!0,xs:12,md:4,children:e.jsx(J,{direction:"row",spacing:1,flexWrap:"wrap",children:t.appliesTo.map(s=>e.jsx(F,{label:s,size:"small"},s))})}),e.jsx(a,{item:!0,xs:12,md:1,children:e.jsx(F,{size:"small",label:t.active?"active":"inactive",color:t.active?"success":"default"})}),e.jsxs(a,{item:!0,xs:12,md:2,textAlign:"right",children:[e.jsx(q,{onClick:()=>ie(n),children:e.jsx(je,{})}),e.jsx(q,{color:"error",onClick:()=>se(n),children:e.jsx(be,{})})]})]})},t.key))})]}),e.jsx(a,{item:!0,xs:12,mt:2,children:e.jsx(M,{type:"submit",variant:"contained",color:"primary",disabled:m,startIcon:m?e.jsx(L,{size:18}):void 0,children:m?"Savingâ€¦":"Save Configuration"})})]})})}),e.jsx(V,{open:!!D,autoHideDuration:5e3,onClose:()=>W(""),message:D}),e.jsx(V,{open:!!o,autoHideDuration:6e3,onClose:()=>l(""),children:e.jsx(K,{severity:"error",onClose:()=>l(""),children:o})}),e.jsxs(xe,{open:ee,onClose:()=>w(!1),fullWidth:!0,maxWidth:"sm",children:[e.jsx(pe,{children:A===null?"Add Pricing Tier":"Edit Pricing Tier"}),e.jsx(ye,{dividers:!0,children:e.jsxs(a,{container:!0,spacing:2,sx:{mt:0},children:[e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{label:"Tier Key",fullWidth:!0,value:d.key,onChange:t=>j(n=>({...n,key:t.target.value.trim()})),helperText:"Unique ID (e.g., standard, vip)",required:!0})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{label:"Tier Name",fullWidth:!0,value:d.name,onChange:t=>j(n=>({...n,name:t.target.value})),required:!0})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(x,{label:"Description",fullWidth:!0,multiline:!0,minRows:2,value:d.description||"",onChange:t=>j(n=>({...n,description:t.target.value}))})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{label:"Price (cents)",type:"number",fullWidth:!0,inputProps:{min:0,step:1},value:d.priceCents,onChange:t=>j(n=>({...n,priceCents:Math.max(0,parseInt(t.target.value||"0",10))})),required:!0})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(x,{select:!0,label:"Currency",fullWidth:!0,value:d.currency||i.currency,onChange:t=>j(n=>({...n,currency:t.target.value})),children:["USD","EUR","GBP","CAD","AUD","JMD"].map(t=>e.jsx($,{value:t,children:t},t))})}),e.jsxs(a,{item:!0,xs:12,children:[e.jsx(Y,{sx:{mb:1,display:"block"},children:"Applies To"}),e.jsx(J,{direction:"row",spacing:1,children:["tour","event","product"].map(t=>{const n=d.appliesTo.includes(t);return e.jsx(F,{label:t,color:n?"primary":"default",variant:n?"filled":"outlined",onClick:()=>j(s=>{const r=new Set(s.appliesTo);r.has(t)?r.delete(t):r.add(t);const f=Array.from(r);return{...s,appliesTo:f.length?f:["tour"]}})},t)})})]}),e.jsx(a,{item:!0,xs:12,children:e.jsx(R,{control:e.jsx(O,{checked:d.active,onChange:(t,n)=>j(s=>({...s,active:n}))}),label:"Active"})})]})}),e.jsxs(fe,{children:[e.jsx(M,{onClick:()=>w(!1),children:"Cancel"}),e.jsx(M,{variant:"contained",onClick:ae,children:"Save Tier"})]})]})]}):e.jsx(G,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(K,{severity:"error",children:"You do not have permission to access this page."})})};export{We as default};
//# sourceMappingURL=StripeConfig.CdTcJEuB.js.map
